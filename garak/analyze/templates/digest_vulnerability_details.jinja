{%if has_enhanced_details%}
<div class="vulnerability-details defcon{{severity_defcon}}" style="margin-left: 80pt; margin-top: 12pt; margin-bottom: 12pt; padding: 12pt; border: 2px solid #e0e0e0; border-radius: 4px; background-color: #fafafa;">

  <h5 style="margin-top: 0; padding-left: 0; color: #d32f2f;">
    <span style="font-size: 1.2em;">üîç</span> Vulnerability Details
  </h5>

  {% if vulnerability_explanation %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;"><strong>Explanation:</strong></p>
    <p style="margin-left: 12pt; line-height: 1.5;">{{ vulnerability_explanation }}</p>
  </div>
  {% endif %}

  {% if attack_technique %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;"><strong>Attack Technique:</strong> <span style="background-color: #fff3cd; padding: 2pt 8pt; border-radius: 3px;">{{ attack_technique }}</span></p>
  </div>
  {% endif %}

  {% if severity %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;">
      <strong>Severity:</strong>
      <span class="defcon{{severity_defcon}}" style="padding: 4pt 12pt; border-radius: 3px; font-weight: bold; text-transform: uppercase;">
        {{ severity }}
      </span>
    </p>
  </div>
  {% endif %}

  {% if cwe_ids or owasp_categories %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;"><strong>Classifications:</strong></p>
    <div style="margin-left: 12pt;">
      {% if cwe_ids %}
      <p style="margin: 2pt 0;">
        <span style="font-weight: 500;">CWE:</span>
        {% for cwe in cwe_ids %}
        <span style="background-color: #e3f2fd; padding: 2pt 6pt; margin-right: 4pt; border-radius: 3px; font-family: monospace; font-size: 0.9em;">{{ cwe }}</span>
        {% endfor %}
      </p>
      {% endif %}
      {% if owasp_categories %}
      <p style="margin: 2pt 0;">
        <span style="font-weight: 500;">OWASP:</span>
        {% for owasp in owasp_categories %}
        <span style="background-color: #f3e5f5; padding: 2pt 6pt; margin-right: 4pt; border-radius: 3px; font-family: monospace; font-size: 0.9em;">{{ owasp }}</span>
        {% endfor %}
      </p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if mitigation_recommendations %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;">
      <strong style="color: #388e3c;">
        <span style="font-size: 1.1em;">üõ°Ô∏è</span> Mitigation Recommendations ({{ mitigation_recommendations|length }} actions):
      </strong>
    </p>
    <ol style="margin-left: 20pt; line-height: 1.6;">
      {% for mitigation in mitigation_recommendations %}
      <li style="margin-bottom: 6pt;">{{ mitigation }}</li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

  {% if reproduction_steps %}
  <div style="margin-bottom: 16pt;">
    <p style="margin: 4pt 0;">
      <strong style="color: #f57c00;">
        <span style="font-size: 1.1em;">üìã</span> Reproduction Steps:
      </strong>
    </p>
    <ol style="margin-left: 20pt; line-height: 1.6; background-color: #fff8e1; padding: 12pt; border-radius: 4px;">
      {% for step in reproduction_steps %}
      <li style="margin-bottom: 6pt;">{{ step }}</li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

  {% if execution_timeline %}
  <div style="margin-bottom: 16pt;">
    <details style="cursor: pointer;">
      <summary style="font-weight: bold; color: #1976d2; margin-bottom: 8pt;">
        <span style="font-size: 1.1em;">‚è±Ô∏è</span> Execution Timeline ({{ execution_timeline|length }} steps)
      </summary>
      <div style="margin-left: 12pt; margin-top: 8pt; font-family: monospace; font-size: 0.85em; background-color: #f5f5f5; padding: 12pt; border-radius: 4px; max-height: 400px; overflow-y: auto;">
        {% for entry in execution_timeline %}
        <div style="margin-bottom: 8pt; padding: 6pt; background-color: white; border-left: 3px solid #2196f3; padding-left: 8pt;">
          <p style="margin: 2pt 0; font-weight: bold; color: #1976d2;">Step {{ entry.step }}: {{ entry.action }}</p>
          <p style="margin: 2pt 0; color: #666; font-size: 0.9em;">{{ entry.timestamp }}</p>
          {% if entry.prompt_text %}
          <p style="margin: 4pt 0;"><em>Prompt:</em> {{ entry.prompt_text[:100] }}{% if entry.prompt_text|length > 100 %}...{% endif %}</p>
          {% endif %}
          {% if entry.response_text %}
          <p style="margin: 4pt 0;"><em>Response #{{ entry.generation }}:</em> {{ entry.response_text[:100] }}{% if entry.response_text|length > 100 %}...{% endif %}</p>
          {% endif %}
          {% if entry.detector %}
          <p style="margin: 4pt 0;"><em>Detector:</em> {{ entry.detector }} | <em>Score:</em> {{ entry.score }} | <em>Result:</em> {{ entry.result }}</p>
          {% endif %}
          {% if entry.status %}
          <p style="margin: 4pt 0;"><em>Final Status:</em> {{ entry.status }} | <em>Vulnerability:</em> {{ entry.vulnerability_found }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </details>
  </div>
  {% endif %}

  {% if references %}
  <div style="margin-bottom: 8pt;">
    <details style="cursor: pointer;">
      <summary style="font-weight: bold; color: #5e35b1;">
        <span style="font-size: 1.1em;">üìö</span> References ({{ references|length }} items)
      </summary>
      <ul style="margin-left: 20pt; margin-top: 8pt; line-height: 1.6;">
        {% for ref in references %}
        <li style="margin-bottom: 6pt;">
          <strong>{{ ref.title }}</strong> ({{ ref.type }})
          {% if ref.url %}
          <br><a href="{{ ref.url }}" target="_blank" style="color: #1976d2; text-decoration: none; font-size: 0.9em;">{{ ref.url }}</a>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </details>
  </div>
  {% endif %}

  {% if timestamp %}
  <div style="margin-top: 16pt; padding-top: 8pt; border-top: 1px solid #e0e0e0; font-size: 0.85em; color: #666;">
    <p style="margin: 0;">Tested: {{ timestamp }}</p>
  </div>
  {% endif %}

</div>
{% endif %}
